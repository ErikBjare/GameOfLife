<html>
	<head>
		<title>Game Of Life</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="misc.js"></script>
	</head>

	<body>
		<canvas id="canvas"></canvas>
		<div style="position: absolute; left: 50%; top: 20px;">
        	<div id="overlay" style="position: relative; left: -50%;">
            	<h1>Game of Life</h1>
        	</div>
    	</div>

    	<a href="https://github.com/you"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png" alt="Fork me on GitHub"></a>

		<script type="text/javascript">
			var canvas=document.getElementById("canvas");
			var ctx=canvas.getContext("2d");

			// Default vars
			var spawnrate = 0.1
			var cellSize = 8;
			var gridSize = 300;
			var updateInterval = 200;

			var grid;

			function init() {
				param_spawnrate = $.getUrlVar("spawnrate")
				if(param_spawnrate) spawnrate = parseFloat(param_spawnrate);

				param_cellSize = $.getUrlVar("cellSize")
				if(param_cellSize) cellSize = parseFloat(param_cellSize);

				param_gridSize = $.getUrlVar("gridSize")
				if(param_gridSize) gridSize = parseFloat(param_gridSize);

				param_updateInterval = $.getUrlVar("updateInterval")
				if(param_updateInterval) updateInterval = parseFloat(param_updateInterval);

				param_undead = $.getUrlVar("undead")
				if(param_undead) rule_standard = rule_undead;

				grid = new Array(gridSize);

				for (var i=0; i<gridSize; i++) {
					grid[i] = new Array(gridSize);
					for (var j=0; j<gridSize; j++) {
						grid[i][j] = Math.round(Math.random()-(spawnrate-0.5)) <= 0 ? true:false;
					}
				}
			}

			function main() {
				window.addEventListener('resize', resizeCanvas, false);

			    resizeCanvas()

				setInterval(nextCycle, updateInterval);
			}

			function nextCycle(timestamp) {
				grid = rule_standard(grid)
				window.requestAnimationFrame(draw)
			}

			function neighbors(row, col) {
				return grid[row-1][col-1] + grid[row-1][col] + grid[row-1][col+1] +
					   grid[row][col-1]   +                  + grid[row][col+1]   +
					   grid[row+1][col-1] + grid[row+1][col] + grid[row+1][col+1]
			}

			function rule_standard(grid) {
				newGrid = clone(grid)
				for (var i=1; i<gridSize-1; i++) {
					for (var j=1; j<gridSize-1; j++) {
						n = neighbors(i, j)
						if(newGrid[i][j]) {
							if (n < 2) newGrid[i][j] = false;
							else if (n <= 3) newGrid[i][j] = true;
							else if (n > 3) newGrid[i][j] = false;
						} else {
							if (n == 3) newGrid[i][j] = true;
						}
					}
				}
				return newGrid
			}

			function rule_undead(grid) {
				// Does not care if a cell is alive or not
				newGrid = clone(grid)
				for (var i=1; i<gridSize-1; i++) {
					for (var j=1; j<gridSize-1; j++) {
						n = neighbors(i, j)
						if (n < 2) newGrid[i][j] = false;
						else if (n <= 3) newGrid[i][j] = true;
						else if (n > 3) newGrid[i][j] = false;
					}
				}
				return newGrid
			}

			function output(grid) {
				o = $("#output");
				o.html("");
				for (var row in grid) {
					o.append("[");
					for (var col in grid[row]) {
						if(grid[row][col] == false) {
							o.append("O");
						} else {
							o.append("X");
						}
					}
					o.append("]<br>");
				}
			}

			function draw() {
				clearCanvas()
				ctx.fillStyle="#FFFFFF";
				ctx.strokeStyle="#FFFFFF"

				rows = grid.length
				cols = grid[0].length

				offsetWidth = (canvas.width-cellSize*cols)/2
				offsetHeight = (canvas.height-cellSize*rows)/2

				for (var row in grid) {
					for (var col in grid[row]) {
						if(grid[row][col] == true) {
							ctx.fillStyle="#FFFFFF";
						} else {
							ctx.fillStyle="#000000";
						}
						ctx.fillRect(offsetWidth+row*cellSize+1,  offsetHeight+col*cellSize+1,
										     cellSize-1,    cellSize-1)
					}
				}

				ctx.strokeStyle="#FFFFFF"
				ctx.rect(offsetWidth, offsetHeight,
					     gridSize*cellSize+1, gridSize*cellSize+1);
				ctx.stroke();
			}

			function clearCanvas() {
				offsetWidth = (canvas.width-cellSize*gridSize)/2
				offsetHeight = (canvas.height-cellSize*gridSize)/2

				oldFill = ctx.fillStyle;
				ctx.fillStyle = "#222222";
				ctx.fillRect(offsetWidth, offsetHeight,
					         gridSize*cellSize, gridSize*cellSize);
				ctx.fillStyle = oldFill;
			}

			function resizeCanvas() {
				canvas.width = $("#canvas").width();
				canvas.height = $("#canvas").height();
				draw();
			}

			init()
			main()
		</script>
	</body>
</html>